CKEDITOR.dialog.add("image2",function(a){function t(){var t=this.getValue().match(C);return(t=!(!t||0===parseInt(t[1],10)))||alert(_.invalidLength.replace("%1",_[this.id]).replace("%2","px")),t}function e(){function a(t,i){o.push(n.once(t,function(t){for(var e;e=o.pop();)e.removeListener();i(t)}))}var n=s.createElement("img"),o=[];return function(t,e,i){a("load",function(){var t=N(n);e.call(i,n,t.width,t.height)}),a("error",function(){e(null)}),a("abort",function(){e(null)}),n.setAttribute("src",(K.baseHref||"")+t+"?"+Math.random().toString(16).substring(2))}}function i(){var t=this.getValue();l(!1),t!==u.data.src?(r(t,function(t,e,i){if(l(!0),!t)return o(!1);V.setValue(!1===a.config.image2_prefillDimensions?0:e),k.setValue(!1===a.config.image2_prefillDimensions?0:i),p=c=e,g=h=i,o(E.checkHasNaturalRatio(t))}),f=!0):f?(l(!0),V.setValue(c),k.setValue(h),f=!1):l(!0)}function n(){if(m&&((a=this.getValue())&&(a.match(C)||o(!1),"0"!==a))){var t="width"==this.id,e=c||p,i=h||g,a=t?Math.round(a/e*i):Math.round(a/i*e);isNaN(a)||(t?k:V).setValue(a)}}function o(t){if(v){if("boolean"==typeof t){if(b)return;m=t}else t=V.getValue(),b=!0,(m=!m)&&t&&(t*=h/c,isNaN(t)||k.setValue(Math.round(t)));v[m?"removeClass":"addClass"]("cke_btn_unlocked"),v.setAttribute("aria-checked",m),CKEDITOR.env.hc&&v.getChild(0).setHtml(m?CKEDITOR.env.ie?"\u25a0":"\u25a3":CKEDITOR.env.ie?"\u25a1":"\u25a2")}}function l(t){V[t=t?"enable":"disable"](),k[t]()}var s,u,d,r,c,h,p,g,f,m,b,v,y,V,k,w,C=/(^\s*(\d+)(px)?\s*$)|^$/i,D=CKEDITOR.tools.getNextId(),x=CKEDITOR.tools.getNextId(),I=a.lang.image2,_=a.lang.common,R=new CKEDITOR.template('<div><a href="javascript:void(0)" tabindex="-1" title="'+I.lockRatio+'" class="cke_btn_locked" id="{lockButtonId}" role="checkbox"><span class="cke_icon"></span><span class="cke_label">'+I.lockRatio+'</span></a><a href="javascript:void(0)" tabindex="-1" title="'+I.resetSize+'" class="cke_btn_reset" id="{resetButtonId}" role="button"><span class="cke_label">'+I.resetSize+"</span></a></div>").output({lockButtonId:D,resetButtonId:x}),E=CKEDITOR.plugins.image2,K=a.config,T=!(!K.filebrowserImageBrowseUrl&&!K.filebrowserBrowseUrl),B=a.widgets.registered.image.features,N=E.getNatural,O=[{id:"src",type:"text",label:_.url,onKeyup:i,onChange:i,setup:function(t){this.setValue(t.data.src)},commit:function(t){t.setData("src",this.getValue())},validate:CKEDITOR.dialog.validate.notEmpty(I.urlMissing)}];return T&&O.push({type:"button",id:"browse",style:"display:inline-block;margin-top:14px;",align:"center",label:a.lang.common.browseServer,hidden:!0,filebrowser:"info:src"}),{title:I.title,minWidth:250,minHeight:100,onLoad:function(){s=this._.element.getDocument(),r=e()},onShow:function(){u=this.widget,d=u.parts.image,f=b=m=!1,w=N(d),p=c=w.width,g=h=w.height},contents:[{id:"info",label:I.infoTab,elements:[{type:"vbox",padding:0,children:[{type:"hbox",widths:["100%"],className:"cke_dialog_image_url",children:O}]},{id:"alt",type:"text",label:I.alt,setup:function(t){this.setValue(t.data.alt)},commit:function(t){t.setData("alt",this.getValue())},validate:!0===a.config.image2_altRequired?CKEDITOR.dialog.validate.notEmpty(I.altMissing):null},{type:"hbox",widths:["25%","25%","50%"],requiredContent:B.dimension.requiredContent,children:[{type:"text",width:"45px",id:"width",label:_.width,validate:t,onKeyUp:n,onLoad:function(){V=this},setup:function(t){this.setValue(t.data.width)},commit:function(t){t.setData("width",this.getValue())}},{type:"text",id:"height",width:"45px",label:_.height,validate:t,onKeyUp:n,onLoad:function(){k=this},setup:function(t){this.setValue(t.data.height)},commit:function(t){t.setData("height",this.getValue())}},{id:"lock",type:"html",style:"margin-top:18px;width:40px;height:20px;",onLoad:function(){function t(t){t.on("mouseover",function(){this.addClass("cke_btn_over")},t),t.on("mouseout",function(){this.removeClass("cke_btn_over")},t)}var e=this.getDialog();v=s.getById(D),y=s.getById(x),v&&(e.addFocusable(v,4+T),v.on("click",function(t){o(),t.data&&t.data.preventDefault()},this.getDialog()),t(v)),y&&(e.addFocusable(y,5+T),y.on("click",function(t){f?(V.setValue(p),k.setValue(g)):(V.setValue(c),k.setValue(h)),t.data&&t.data.preventDefault()},this),t(y))},setup:function(t){o(t.data.lock)},commit:function(t){t.setData("lock",m)},html:R}]},{type:"hbox",id:"alignment",requiredContent:B.align.requiredContent,children:[{id:"align",type:"radio",items:[[_.alignNone,"none"],[_.left,"left"],[_.center,"center"],[_.right,"right"]],label:_.align,setup:function(t){this.setValue(t.data.align)},commit:function(t){t.setData("align",this.getValue())}}]},{id:"hasCaption",type:"checkbox",label:I.captioned,requiredContent:B.caption.requiredContent,setup:function(t){this.setValue(t.data.hasCaption)},commit:function(t){t.setData("hasCaption",this.getValue())}}]},{id:"Upload",hidden:!0,filebrowser:"uploadButton",label:I.uploadTab,elements:[{type:"file",id:"upload",label:I.btnUpload,style:"height:40px"},{type:"fileButton",id:"uploadButton",filebrowser:"info:src",label:I.btnUpload,"for":["Upload","upload"]}]}]}});
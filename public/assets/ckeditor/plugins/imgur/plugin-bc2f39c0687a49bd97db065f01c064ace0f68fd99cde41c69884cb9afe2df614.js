CKEDITOR.plugins.add("imgur",{lang:["zh","en"],init:function(o){ClientID=o.config.imgurClientID,ClientID||alert(o.lang.imgur.ClientIDMissing);var l=0,s=$("<div></div>").css({position:"absolute",bottom:0,left:0,right:0,backgroundColor:"rgba(20, 20, 20, .6)",padding:5,color:"#fff"}).hide();o.on("instanceReady",function(){var e=$(o.window.getFrame().$).parent();e.css({position:"relative"}),s.appendTo(e)}),o.ui.addButton("Imgur",{label:o.lang.imgur.label,toolbar:"insert",command:"imgur",icon:this.path+"images/icon.png"}),o.addCommand("imgur",{exec:function(){$input=$('<input type="file" multiple/>'),$input.on("change",function(e){files=e.target.files,$.each(files,function(e,a){l++,form=new FormData,form.append("image",a),$.ajax({url:"https://api.imgur.com/3/image",headers:{Authorization:"Client-ID "+ClientID},type:"POST",data:form,cache:!1,contentType:!1,processData:!1}).always(function(e){if(l--,s.text(l+o.lang.imgur.uploading).toggle(0!=l),200!=e.status?res=$.parseJSON(e.responseText):res=e,res.data.error)alert(o.lang.imgur.failToUpload+res.data.error);else{content='<img src="'+res.data.link+'"/>';var a=CKEDITOR.dom.element.createFromHtml(content);o.insertElement(a)}})}),s.text(l+o.lang.imgur.uploading).fadeIn()}),$input.click()}}),o.on("paste",function(e){var a,t=e.data,n=document.implementation.createHTMLDocument("");if(new CKEDITOR.dom.element(n.body),t&&t.dataValue&&t.dataValue.startsWith("<img")){l++;var r=$(t.dataValue).attr("src");r=r.replace(/^data:image\/(png|jpg);base64,/,"");var i=new FormData;return i.append("image",r),$.ajax({url:"https://api.imgur.com/3/image",headers:{Authorization:"Client-ID "+o.config.imgurClientID},type:"POST",data:i,cache:!1,contentType:!1,processData:!1}).always(function(e){if(l--,s.text(l+o.lang.imgur.uploading).toggle(0!=l),200!=e.status?res=$.parseJSON(e.responseText):res=e,res.data.error)alert(o.lang.imgur.failToUpload+res.data.error);else{content='<img src="'+res.data.link+'"/>';var a=CKEDITOR.dom.element.createFromHtml(content);o.insertElement(a)}}),s.text(l+o.lang.imgur.uploading).fadeIn(),!1}for(a=0;a<e.data.dataTransfer.getFilesCount();a++)return l++,file=e.data.dataTransfer.getFile(a),(i=new FormData).append("image",file),$.ajax({url:"https://api.imgur.com/3/image",headers:{Authorization:"Client-ID "+o.config.imgurClientID},type:"POST",data:i,cache:!1,contentType:!1,processData:!1}).always(function(e){if(l--,s.text(l+o.lang.imgur.uploading).toggle(0!=l),200!=e.status?res=$.parseJSON(e.responseText):res=e,res.data.error)alert(o.lang.imgur.failToUpload+res.data.error);else{content='<img src="'+res.data.link+'"/>';var a=CKEDITOR.dom.element.createFromHtml(content);o.insertElement(a)}}),s.text(l+o.lang.imgur.uploading).fadeIn(),!1;return!0})}});